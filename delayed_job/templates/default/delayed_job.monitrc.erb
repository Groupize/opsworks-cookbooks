<% @delayed_job[:pool].each do |key, config| %>
<% identifier = "#{@application}-#{key}" %>
# Set envrionment variables
env_vars = ''
<% if @deploy[:env] %>
  <% @deploy[:env].each_pair do |env_var, var_val| %>
    <% unless env_var == 'PORT' || env_var == 'RACK_ENV' %>
      env_vars += " " + <%= env_var %>='<%= var_val %>'
    <% end %>
  <% end %>
<% end %>
check process delayed_job.<%= identifier %>
  with pidfile <%= @deploy[:deploy_to] %>/shared/pids/delayed_job.<%= identifier %>.pid
  start program = "/bin/su - <%= @deploy[:user] %> -c 'cd <%= @deploy[:current_path] %> && <%= env_vars %> RAILS_ENV=<%= @deploy[:rails_env] %> bundle exec script/delayed_job start --identifier=<%= identifier %> <%= ("--queues=#{config['queues']}" if (config && config['queues'])) %>'"
  stop  program = "/bin/su - <%= @deploy[:user] %> -c 'cd <%= @deploy[:current_path] %> && <%= env_vars %> RAILS_ENV=<%= @deploy[:rails_env] %> bundle exec script/delayed_job stop --identifier=<%= identifier %>'"
  group delayed_job_<%= @application %>_group

<% end %>
